# ═══════════════════════════════════════════════════════════════════════════════
# DOCKER COMPOSE - Task API
#
# Configurazione per sviluppo e produzione.
# Uso: docker compose up -d
# ═══════════════════════════════════════════════════════════════════════════════

services:
  api:
    # === BUILD CONFIGURATION ===
    build:
      context: .
      dockerfile: Dockerfile
      # Cache delle dipendenze per build più veloci
      args:
        - BUILDKIT_INLINE_CACHE=1
    
    # Nome container esplicito (opzionale, utile per riferimenti)
    container_name: task-api
    
    # === RESTART POLICY ===
    # 'unless-stopped': riavvia sempre tranne se fermato manualmente
    # Altre opzioni: 'no', 'always', 'on-failure'
    restart: unless-stopped
    
    # === PORT MAPPING ===
    # Formato: "HOST:CONTAINER"
    ports:
      - "${PORT:-3000}:3000"
    
    # === ENVIRONMENT ===
    # Le variabili vengono lette dal file .env automaticamente
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      - HOST=0.0.0.0
      - DB_PATH=/app/data/tasks.db
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
    
    # === VOLUMES ===
    volumes:
      # Volume nominato per persistenza database SQLite
      # I dati sopravvivono a 'docker compose down' (ma non a 'down -v')
      - sqlite_data:/app/data
    
    # === HEALTHCHECK ===
    # Sovrascrive l'healthcheck del Dockerfile se necessario
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # === RESOURCE LIMITS ===
    # Limita le risorse per evitare che un container monopolizzi l'host
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    
    # === LOGGING ===
    # Configura il driver di logging e limita la dimensione dei log
    logging:
      driver: json-file
      options:
        max-size: "10m"    # Ruota i log quando raggiungono 10MB
        max-file: "3"      # Mantiene massimo 3 file di log
    
    # === SECURITY ===
    # Opzioni di sicurezza aggiuntive
    security_opt:
      - no-new-privileges:true    # Impedisce escalation di privilegi
    
    # === DEVELOPMENT MODE ===
    # Configurazione per hot-reload durante lo sviluppo
    # Attivare con: docker compose watch
    develop:
      watch:
        # Sincronizza modifiche al codice sorgente
        - action: sync
          path: ./src
          target: /app/src
        
        # Rebuild se package.json cambia
        - action: rebuild
          path: ./package.json

# === VOLUMES DEFINITION ===
volumes:
  sqlite_data:
    # Driver locale (default)
    driver: local
    # Nome esplicito per identificazione
    name: task-api-sqlite-data
